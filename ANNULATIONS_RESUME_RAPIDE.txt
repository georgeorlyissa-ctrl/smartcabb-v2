====================================================================
  SYST√àME D'ANNULATIONS AVEC RAISONS - R√âSUM√â RAPIDE
====================================================================

üéØ OBJECTIF:
  Quand un passager annule une course:
  1. Il choisit une raison dans une liste
  2. L'annulation est enregistr√©e dans l'historique
  3. Les admins peuvent voir toutes les annulations et leurs raisons

--------------------------------------------------------------------
üì¶ FICHIERS CR√â√âS/MODIFI√âS (5 fichiers)
--------------------------------------------------------------------

BACKEND (2 fichiers modifi√©s):

1. supabase/functions/server/ride-routes.tsx ‚úÖ
   ‚Üí Route POST /cancel modifi√©e
   ‚Üí Enregistre dans passenger_cancellation:{userId}:{timestamp}
   ‚Üí Sauvegarde: raison, pickup, destination, prix, p√©nalit√©

2. supabase/functions/server/admin-routes.tsx ‚úÖ
   ‚Üí Route GET /admin/cancellations (toutes les annulations)
   ‚Üí Route GET /admin/cancellations/:userId (annulations d'un user)
   ‚Üí Statistiques: total, par type, par raison, p√©nalit√©s

FRONTEND (2 nouveaux composants):

3. components/CancelRideModal.tsx ‚úÖ CR√â√â
   ‚Üí Modal avec 10 raisons pr√©d√©finies:
     - Changement de plans
     - Temps d'attente trop long
     - Chauffeur trop loin
     - Prix trop √©lev√©
     - Trouv√© autre transport
     - Urgence / Impr√©vu
     - Erreur d'adresse
     - Probl√®me v√©hicule
     - Comportement chauffeur
     - Autre raison (texte libre)
   ‚Üí Affiche avertissement si p√©nalit√©
   ‚Üí Validation avant confirmation

4. components/admin/CancellationsScreen.tsx ‚úÖ CR√â√â
   ‚Üí Page admin compl√®te avec:
     - 5 cartes statistiques (total, passagers, conducteurs, p√©nalit√©s)
     - Top 6 raisons d'annulation
     - Filtres (tous / passagers / conducteurs)
     - Recherche (nom, t√©l√©phone, raison)
     - Liste d√©taill√©e de toutes les annulations

--------------------------------------------------------------------
üîß CE QU'IL RESTE √Ä FAIRE
--------------------------------------------------------------------

1. INT√âGRER LE MODAL DANS L'APP PASSAGER:
   
   Dans PassengerApp.tsx ou RideSearchScreen.tsx:
   
   a) Importer le composant:
      import { CancelRideModal } from './components/CancelRideModal';
   
   b) Ajouter l'√©tat:
      const [showCancelModal, setShowCancelModal] = useState(false);
   
   c) Remplacer le bouton d'annulation actuel:
      <Button onClick={() => setShowCancelModal(true)}>
        Annuler la course
      </Button>
   
   d) Ajouter le modal dans le JSX:
      <CancelRideModal
        isOpen={showCancelModal}
        onClose={() => setShowCancelModal(false)}
        onConfirm={async (reason) => {
          // Appeler la route /cancel avec la raison
          const response = await fetch('...', {
            body: JSON.stringify({
              rideId: currentRide.id,
              passengerId: currentUser.id,
              reason,  // ‚Üê RAISON S√âLECTIONN√âE
              cancelledBy: 'passenger'
            })
          });
          // G√©rer la r√©ponse
        }}
        rideStatus={currentRide.status}
        hasPenalty={currentRide.status === 'accepted'}
        penaltyAmount={Math.round(currentRide.estimatedPrice * 0.5)}
      />

2. INT√âGRER LA PAGE DANS ADMINDASHBOARD:
   
   a) Importer le composant:
      import { CancellationsScreen } from './admin/CancellationsScreen';
      import { XCircle } from '../../lib/admin-icons';
   
   b) Ajouter dans les actions (ligne ~600):
      {
        id: 'action-cancellations',
        title: 'Historique annulations',
        description: 'Voir toutes les annulations avec raisons',
        icon: XCircle,
        action: () => setCurrentScreen('cancellations'),
        highlight: true,
        color: 'from-red-500 to-orange-500'
      }
   
   c) Ajouter le rendu conditionnel:
      {currentScreen === 'cancellations' && <CancellationsScreen />}

--------------------------------------------------------------------
‚úÖ CHECKLIST
--------------------------------------------------------------------

Backend:
[x] ride-routes.tsx modifi√© (enregistrement historique)
[x] admin-routes.tsx modifi√© (routes de r√©cup√©ration)

Frontend - Composants:
[x] CancelRideModal.tsx cr√©√©
[x] CancellationsScreen.tsx cr√©√©

Frontend - Int√©gration:
[ ] Int√©grer CancelRideModal dans PassengerApp
[ ] Int√©grer CancellationsScreen dans AdminDashboard
[ ] Importer XCircle dans AdminDashboard

Tests:
[ ] Annuler course pending (sans p√©nalit√©)
[ ] Annuler course accepted (avec p√©nalit√© 50%)
[ ] V√©rifier enregistrement KV store
[ ] Voir l'annulation dans l'admin
[ ] Tester filtres et recherche

--------------------------------------------------------------------
üì¶ FICHIERS √Ä COPIER DANS GITHUB
--------------------------------------------------------------------

Maintenant (backend + composants):
[x] supabase/functions/server/ride-routes.tsx
[x] supabase/functions/server/admin-routes.tsx
[x] components/CancelRideModal.tsx
[x] components/admin/CancellationsScreen.tsx

Apr√®s int√©gration:
[ ] App passager (fichier √† d√©terminer)
[ ] components/admin/AdminDashboard.tsx

--------------------------------------------------------------------
üí° NOTES IMPORTANTES
--------------------------------------------------------------------

1. Le modal affiche un avertissement si p√©nalit√© (course accepted)
2. Les annulations sont enregistr√©es avec TOUTES les infos:
   - Qui (nom, t√©l√©phone, type)
   - Quoi (pickup, destination, prix)
   - Quand (date et heure)
   - Pourquoi (raison s√©lectionn√©e)
   - Combien (p√©nalit√© si applicable)

3. L'admin peut filtrer par:
   - Type (passagers / conducteurs)
   - Recherche (nom, t√©l√©phone, raison)

4. Statistiques automatiques:
   - Total annulations
   - Par passagers / conducteurs
   - Avec p√©nalit√©
   - Total p√©nalit√©s en CDF
   - Top raisons d'annulation

--------------------------------------------------------------------
üöÄ COMMIT MESSAGE SUGG√âR√â
--------------------------------------------------------------------

‚ú® Syst√®me d'annulations avec raisons et historique

Backend:
- Enregistrement annulations dans KV store
- Routes admin pour historique complet
- Statistiques par raison et type

Frontend:
- Modal choix raison (10 options + personnalis√©e)
- Page admin "Historique annulations"
- Filtres et statistiques en temps r√©el

Features:
- Avertissement p√©nalit√© si conducteur accept√©
- Enregistrement complet (qui, quoi, quand, pourquoi)
- Recherche et filtres avanc√©s

====================================================================
Statut: ‚úÖ BACKEND ET COMPOSANTS PR√äTS
Reste: Int√©gration dans PassengerApp et AdminDashboard
Date: 1er f√©vrier 2026
====================================================================
