<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCabb - Nettoyage Syst√®me</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #1557b0;
        }
        button.danger {
            background: #d93025;
        }
        button.danger:hover {
            background: #b8221b;
        }
        button.success {
            background: #1e8e3e;
        }
        button.success:hover {
            background: #188038;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success-result {
            background: #e6f4ea;
            border: 1px solid #1e8e3e;
            color: #188038;
        }
        .error-result {
            background: #fce8e6;
            border: 1px solid #d93025;
            color: #b8221b;
        }
        .info-result {
            background: #e8f0fe;
            border: 1px solid #1a73e8;
            color: #1557b0;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ SmartCabb - Nettoyage Syst√®me</h1>
        <p class="subtitle">Outils d'administration pour r√©initialiser le syst√®me</p>

        <div>
            <button onclick="getSystemStatus()" class="success">üìä Statut du Syst√®me</button>
            <button onclick="deleteAllRides()" class="danger">üóëÔ∏è Supprimer Toutes les Courses</button>
            <button onclick="deleteAllDrivers()" class="danger">üóëÔ∏è Supprimer Tous les Conducteurs</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const BASE_URL = 'https://wmrksqludchpvitakyci.supabase.co/functions/v1/make-server-2eb02e52';

        function showLoading(message) {
            const result = document.getElementById('result');
            result.className = 'info-result';
            result.innerHTML = `${message} <span class="loading"></span>`;
        }

        function showResult(data, isError = false) {
            const result = document.getElementById('result');
            result.className = isError ? 'error-result' : 'success-result';
            result.textContent = JSON.stringify(data, null, 2);
        }

        async function getSystemStatus() {
            try {
                showLoading('‚è≥ R√©cup√©ration du statut syst√®me...');
                const response = await fetch(`${BASE_URL}/admin/system-status`);
                const data = await response.json();
                showResult(data);
                
                // Afficher un r√©sum√©
                if (data.success) {
                    const summary = `
‚úÖ STATUT DU SYST√àME

üë®‚Äç‚úàÔ∏è CONDUCTEURS:
   - Total: ${data.status.drivers.total}
   - En ligne: ${data.status.drivers.online}
   - Hors ligne: ${data.status.drivers.offline}

üöó COURSES:
   - Total: ${data.status.rides.total}
   - En attente: ${data.status.rides.pending}
   - Accept√©es: ${data.status.rides.accepted}

üîß ENVIRONNEMENT:
   - Firebase: ${data.status.environment.hasFirebase ? '‚úÖ' : '‚ùå'}
   - Africa's Talking: ${data.status.environment.hasAfricasTalking ? '‚úÖ' : '‚ùå'}
   - Supabase: ${data.status.environment.hasSupabase ? '‚úÖ' : '‚ùå'}

${data.status.drivers.details.length > 0 ? '\nüìã D√âTAILS DES CONDUCTEURS:\n' + data.status.drivers.details.map(d => 
    `   - ${d.name} (${d.phone}): ${d.isOnline ? 'üü¢ EN LIGNE' : 'üî¥ HORS LIGNE'} | GPS: ${d.location?.hasGPS ? '‚úÖ' : '‚ùå'} | Note: ${d.rating}/5`
).join('\n') : ''}
`;
                    alert(summary);
                }
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function deleteAllRides() {
            if (!confirm('‚ö†Ô∏è ATTENTION ! Voulez-vous vraiment supprimer TOUTES les courses ?\n\nCette action est irr√©versible.')) {
                return;
            }

            try {
                showLoading('‚è≥ Suppression de toutes les courses...');
                const response = await fetch(`${BASE_URL}/admin/delete-all-rides`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult(data);
                
                if (data.success) {
                    alert(`‚úÖ ${data.count} course(s) supprim√©e(s) avec succ√®s !`);
                }
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function deleteAllDrivers() {
            if (!confirm('‚ö†Ô∏è ATTENTION ! Voulez-vous vraiment supprimer TOUS les conducteurs ?\n\nCette action est irr√©versible.\n\nLes comptes Supabase Auth ne seront PAS supprim√©s, seulement les donn√©es du KV store.')) {
                return;
            }

            try {
                showLoading('‚è≥ Suppression de tous les conducteurs...');
                const response = await fetch(`${BASE_URL}/admin/delete-all-drivers`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult(data);
                
                if (data.success) {
                    alert(`‚úÖ ${data.count} conducteur(s) supprim√©(s) avec succ√®s !`);
                }
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        // Charger le statut au d√©marrage
        window.addEventListener('load', () => {
            getSystemStatus();
        });
    </script>
</body>
</html>
