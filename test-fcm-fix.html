<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üî• Test FCM SmartCabb - V√©rification Configuration</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }
    
    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .test-section {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #4299e1;
    }
    
    .test-section h2 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }
    
    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .status.pending {
      background: #feebc8;
      color: #744210;
    }
    
    .log-line {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 6px;
      background: white;
      border-left: 3px solid #cbd5e0;
    }
    
    .log-line.success {
      border-left-color: #48bb78;
      background: #f0fff4;
    }
    
    .log-line.error {
      border-left-color: #f56565;
      background: #fff5f5;
    }
    
    .log-line.warning {
      border-left-color: #ed8936;
      background: #fffaf0;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-right: 10px;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .code-block {
      background: #2d3748;
      color: #a0aec0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin: 10px 0;
    }
    
    .code-block .key {
      color: #81e6d9;
    }
    
    .code-block .string {
      color: #fbd38d;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî• Test Configuration Firebase FCM</h1>
    <p class="subtitle">SmartCabb - V√©rification Push Notifications</p>
    
    <!-- TEST 1: Configuration Firebase -->
    <div class="test-section">
      <h2>
        Test 1 : Configuration Firebase
        <span class="status pending" id="status-config">En attente</span>
      </h2>
      <div id="logs-config"></div>
      <button onclick="testFirebaseConfig()">üîç V√©rifier Config</button>
    </div>
    
    <!-- TEST 2: Service Worker -->
    <div class="test-section">
      <h2>
        Test 2 : Service Worker Firebase
        <span class="status pending" id="status-sw">En attente</span>
      </h2>
      <div id="logs-sw"></div>
      <button onclick="testServiceWorker()">‚öôÔ∏è V√©rifier Service Worker</button>
    </div>
    
    <!-- TEST 3: Permission Notifications -->
    <div class="test-section">
      <h2>
        Test 3 : Permissions Navigateur
        <span class="status pending" id="status-perm">En attente</span>
      </h2>
      <div id="logs-perm"></div>
      <button onclick="testPermissions()">üîî Demander Permissions</button>
    </div>
    
    <!-- TEST 4: G√©n√©ration Token FCM -->
    <div class="test-section">
      <h2>
        Test 4 : G√©n√©ration Token FCM
        <span class="status pending" id="status-token">En attente</span>
      </h2>
      <div id="logs-token"></div>
      <button onclick="testFCMToken()">üîë G√©n√©rer Token FCM</button>
    </div>
    
    <!-- R√âSULTATS FINAUX -->
    <div class="test-section" style="border-left-color: #9f7aea;">
      <h2>üìä R√©sum√© des tests</h2>
      <div id="summary"></div>
      <button onclick="runAllTests()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
        ‚ñ∂Ô∏è Lancer tous les tests
      </button>
      <button onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>
    </div>
  </div>

  <script type="module">
    // Configuration Firebase (doit correspondre √† /lib/firebase-config.ts)
    const EXPECTED_CONFIG = {
      apiKey: "AIzaSyBaQo0fy37kfP5qLCsEHhVY44Ah3PpCbEw",
      authDomain: "smartcabb.firebaseapp.com",
      projectId: "smartcabb",
      storageBucket: "smartcabb.firebasestorage.app",
      messagingSenderId: "396618257088",
      appId: "1:396618257088:web:f97c8aa8a239072ec82cf7",
      measurementId: "G-PQZC05N17H"
    };
    
    const VAPID_KEY = "BDHm-w7od6Q7PP8y_vCv3TxuQiocDUyH3X6sg1zxQfm_KhCSFJnHtcVP4yekIOWUiJ6vHvO06yaXXnyp0i_1Muc";
    
    let firebaseApp = null;
    let messaging = null;
    
    // Fonctions de logging
    function log(section, message, type = 'info') {
      const container = document.getElementById(`logs-${section}`);
      const line = document.createElement('div');
      line.className = `log-line ${type}`;
      
      const timestamp = new Date().toLocaleTimeString('fr-FR');
      line.textContent = `[${timestamp}] ${message}`;
      
      container.appendChild(line);
      container.scrollTop = container.scrollHeight;
    }
    
    function setStatus(section, status) {
      const statusEl = document.getElementById(`status-${section}`);
      statusEl.className = `status ${status}`;
      statusEl.textContent = status === 'success' ? '‚úÖ R√©ussi' : 
                             status === 'error' ? '‚ùå √âchou√©' : 
                             '‚è≥ En cours...';
    }
    
    // TEST 1: Configuration Firebase
    window.testFirebaseConfig = async function() {
      setStatus('config', 'pending');
      log('config', 'üîç V√©rification de la configuration Firebase...', 'info');
      
      try {
        // Import Firebase dynamiquement
        const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        
        // V√©rifier si d√©j√† initialis√©
        const apps = getApps();
        if (apps.length > 0) {
          log('config', '‚ö†Ô∏è Firebase d√©j√† initialis√©, r√©initialisation...', 'warning');
        }
        
        // Initialiser Firebase
        firebaseApp = initializeApp(EXPECTED_CONFIG);
        
        log('config', '‚úÖ Firebase initialis√© avec succ√®s', 'success');
        log('config', `üìã Project ID: ${EXPECTED_CONFIG.projectId}`, 'success');
        log('config', `üìã API Key: ${EXPECTED_CONFIG.apiKey.substring(0, 20)}...`, 'success');
        log('config', `üìã Messaging Sender ID: ${EXPECTED_CONFIG.messagingSenderId}`, 'success');
        
        setStatus('config', 'success');
      } catch (error) {
        log('config', `‚ùå Erreur: ${error.message}`, 'error');
        log('config', `üí° D√©tails: ${error.stack}`, 'error');
        setStatus('config', 'error');
      }
    };
    
    // TEST 2: Service Worker
    window.testServiceWorker = async function() {
      setStatus('sw', 'pending');
      log('sw', '‚öôÔ∏è V√©rification du Service Worker...', 'info');
      
      if (!('serviceWorker' in navigator)) {
        log('sw', '‚ùå Service Worker non support√© par ce navigateur', 'error');
        setStatus('sw', 'error');
        return;
      }
      
      try {
        // V√©rifier les Service Workers existants
        const registrations = await navigator.serviceWorker.getRegistrations();
        log('sw', `üìã ${registrations.length} Service Worker(s) trouv√©(s)`, 'info');
        
        registrations.forEach((reg, i) => {
          log('sw', `  ${i + 1}. Scope: ${reg.scope}`, 'info');
          log('sw', `     √âtat: ${reg.active ? 'active' : 'inactif'}`, 'info');
        });
        
        // Enregistrer le Service Worker Firebase
        log('sw', 'üìù Enregistrement du Service Worker Firebase...', 'info');
        
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
          scope: '/'
        });
        
        log('sw', `‚úÖ Service Worker enregistr√©: ${registration.scope}`, 'success');
        
        // Attendre qu'il soit actif
        await navigator.serviceWorker.ready;
        log('sw', '‚úÖ Service Worker pr√™t et actif', 'success');
        
        // Envoyer la config Firebase au SW
        if (registration.active) {
          registration.active.postMessage({
            type: 'INIT_FIREBASE',
            config: EXPECTED_CONFIG
          });
          log('sw', '‚úÖ Configuration Firebase envoy√©e au Service Worker', 'success');
        }
        
        setStatus('sw', 'success');
      } catch (error) {
        log('sw', `‚ùå Erreur: ${error.message}`, 'error');
        setStatus('sw', 'error');
      }
    };
    
    // TEST 3: Permissions
    window.testPermissions = async function() {
      setStatus('perm', 'pending');
      log('perm', 'üîî V√©rification des permissions...', 'info');
      
      if (!('Notification' in window)) {
        log('perm', '‚ùå Notifications non support√©es par ce navigateur', 'error');
        setStatus('perm', 'error');
        return;
      }
      
      log('perm', `üìã Permission actuelle: ${Notification.permission}`, 'info');
      
      if (Notification.permission === 'granted') {
        log('perm', '‚úÖ Permission d√©j√† accord√©e', 'success');
        setStatus('perm', 'success');
        return;
      }
      
      if (Notification.permission === 'denied') {
        log('perm', '‚ùå Permission refus√©e - R√©initialiser dans les param√®tres du navigateur', 'error');
        setStatus('perm', 'error');
        return;
      }
      
      try {
        log('perm', 'üì± Demande de permission...', 'info');
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          log('perm', '‚úÖ Permission accord√©e !', 'success');
          setStatus('perm', 'success');
        } else {
          log('perm', '‚ùå Permission refus√©e par l\'utilisateur', 'error');
          setStatus('perm', 'error');
        }
      } catch (error) {
        log('perm', `‚ùå Erreur: ${error.message}`, 'error');
        setStatus('perm', 'error');
      }
    };
    
    // TEST 4: Token FCM
    window.testFCMToken = async function() {
      setStatus('token', 'pending');
      log('token', 'üîë G√©n√©ration du token FCM...', 'info');
      
      try {
        // V√©rifier que Firebase est initialis√©
        if (!firebaseApp) {
          log('token', '‚ö†Ô∏è Firebase non initialis√©, initialisation...', 'warning');
          await testFirebaseConfig();
        }
        
        // V√©rifier permission
        if (Notification.permission !== 'granted') {
          log('token', '‚ö†Ô∏è Permission requise, demande...', 'warning');
          await testPermissions();
        }
        
        if (Notification.permission !== 'granted') {
          log('token', '‚ùå Permission refus√©e, impossible de g√©n√©rer le token', 'error');
          setStatus('token', 'error');
          return;
        }
        
        // Import Firebase Messaging
        const { getMessaging, getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');
        
        messaging = getMessaging(firebaseApp);
        log('token', '‚úÖ Firebase Messaging initialis√©', 'success');
        
        // Attendre que le Service Worker soit pr√™t
        const registration = await navigator.serviceWorker.ready;
        log('token', '‚úÖ Service Worker pr√™t', 'success');
        
        // G√©n√©rer le token
        log('token', '‚è≥ G√©n√©ration du token en cours...', 'info');
        
        const token = await getToken(messaging, {
          vapidKey: VAPID_KEY,
          serviceWorkerRegistration: registration
        });
        
        if (token) {
          log('token', '‚úÖ TOKEN FCM OBTENU !', 'success');
          log('token', `üìã Token (30 premiers caract√®res): ${token.substring(0, 30)}...`, 'success');
          log('token', `üìã Longueur: ${token.length} caract√®res`, 'success');
          
          // Copier dans le presse-papier
          try {
            await navigator.clipboard.writeText(token);
            log('token', 'üìã Token copi√© dans le presse-papier !', 'success');
          } catch (e) {
            log('token', '‚ö†Ô∏è Impossible de copier dans le presse-papier', 'warning');
          }
          
          setStatus('token', 'success');
        } else {
          log('token', '‚ùå Aucun token g√©n√©r√©', 'error');
          setStatus('token', 'error');
        }
      } catch (error) {
        log('token', `‚ùå Erreur: ${error.message}`, 'error');
        log('token', `üí° Stack: ${error.stack}`, 'error');
        setStatus('token', 'error');
      }
    };
    
    // Lancer tous les tests
    window.runAllTests = async function() {
      await testFirebaseConfig();
      await new Promise(r => setTimeout(r, 500));
      await testServiceWorker();
      await new Promise(r => setTimeout(r, 500));
      await testPermissions();
      await new Promise(r => setTimeout(r, 500));
      await testFCMToken();
      
      updateSummary();
    };
    
    // Effacer les logs
    window.clearLogs = function() {
      ['config', 'sw', 'perm', 'token'].forEach(section => {
        document.getElementById(`logs-${section}`).innerHTML = '';
        setStatus(section, 'pending');
      });
      document.getElementById('summary').innerHTML = '';
    };
    
    // Mise √† jour du r√©sum√©
    function updateSummary() {
      const summary = document.getElementById('summary');
      const statuses = ['config', 'sw', 'perm', 'token'].map(s => {
        const el = document.getElementById(`status-${s}`);
        return el.className.includes('success');
      });
      
      const successCount = statuses.filter(s => s).length;
      const total = statuses.length;
      
      summary.innerHTML = `
        <div class="log-line ${successCount === total ? 'success' : 'warning'}">
          ‚úÖ ${successCount}/${total} tests r√©ussis
        </div>
        ${successCount === total ? 
          '<div class="log-line success">üéâ Toutes les v√©rifications ont r√©ussi ! Les push notifications sont pr√™tes.</div>' :
          '<div class="log-line error">‚ö†Ô∏è Certains tests ont √©chou√©. V√©rifiez les logs ci-dessus.</div>'
        }
      `;
    }
  </script>
</body>
</html>
