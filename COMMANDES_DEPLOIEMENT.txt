================================================================================
ðŸš€ COMMANDES DE DÃ‰PLOIEMENT - CORRECTION UUID SMARTCABB
================================================================================

ðŸ“‹ Ã‰TAPE 1 : VÃ‰RIFICATION PRÃ‰-DÃ‰PLOIEMENT
--------------------------------------------------------------------------------

# Rendre les scripts exÃ©cutables (Linux/Mac)
chmod +x verify-uuid-validation.sh
chmod +x test-uuid-fix.sh

# VÃ©rifier que les validations UUID sont en place
./verify-uuid-validation.sh


ðŸ“‹ Ã‰TAPE 2 : DÃ‰PLOIEMENT DU BACKEND
--------------------------------------------------------------------------------

# Option A : Linux/Mac
npx supabase functions deploy make-server-2eb02e52

# Option B : Windows (utiliser le fichier batch)
deploy-backend.bat

# Option C : Windows PowerShell
.\deploy-backend.ps1


ðŸ“‹ Ã‰TAPE 3 : VÃ‰RIFICATION POST-DÃ‰PLOIEMENT
--------------------------------------------------------------------------------

# Test de santÃ© (remplacer [PROJECT_ID])
curl https://[PROJECT_ID].supabase.co/functions/v1/make-server-2eb02e52/health

# VÃ©rifier la version
curl https://[PROJECT_ID].supabase.co/functions/v1/make-server-2eb02e52/version

# Ou utiliser le script automatique (remplacer [PROJECT_ID] et [ANON_KEY])
./test-uuid-fix.sh [PROJECT_ID] [ANON_KEY]


ðŸ“‹ Ã‰TAPE 4 : SURVEILLANCE DES LOGS
--------------------------------------------------------------------------------

# Voir les logs en temps rÃ©el
npx supabase functions logs make-server-2eb02e52 --follow

# Voir les derniers logs
npx supabase functions logs make-server-2eb02e52

# Sauvegarder les logs dans un fichier
npx supabase functions logs make-server-2eb02e52 > logs-backend.txt


ðŸ“‹ Ã‰TAPE 5 : TEST D'APPROBATION
--------------------------------------------------------------------------------

1. Ouvrir le panel admin : https://smartcabb.com/admin
2. Se connecter avec le compte admin
3. Aller dans "Gestion des conducteurs"
4. Approuver un conducteur en attente
5. Ouvrir la console DevTools (F12) et vÃ©rifier :
   âœ… Aucune erreur "Expected parameter to be UUID but is not"
   âœ… Messages de succÃ¨s pour les 3 mises Ã  jour (KV, Auth, Postgres)

6. Se dÃ©connecter du panel admin
7. Se connecter avec le compte conducteur : https://smartcabb.com/driver
8. VÃ‰RIFIER : Le conducteur voit son tableau de bord (PAS le message "En attente")


ðŸ“‹ Ã‰TAPE 6 : VÃ‰RIFICATION DE LA SYNCHRONISATION
--------------------------------------------------------------------------------

# Debug d'un conducteur spÃ©cifique (remplacer [PROJECT_ID], [DRIVER_ID], [ANON_KEY])
curl "https://[PROJECT_ID].supabase.co/functions/v1/make-server-2eb02e52/drivers/[DRIVER_ID]/debug" \
  -H "Authorization: Bearer [ANON_KEY]" \
  | jq '.'

# VÃ©rifier que les 3 sources ont le mÃªme statut :
# - sources.kv_store.status = "approved"
# - sources.auth.status_in_metadata = "approved"
# - sources.postgres_drivers.status = "approved"


ðŸ“‹ COMMANDES DE DÃ‰PANNAGE
--------------------------------------------------------------------------------

# VÃ©rifier le statut de Supabase
npx supabase status

# Se connecter Ã  Supabase (si pas dÃ©jÃ  connectÃ©)
npx supabase login

# Lister toutes les fonctions dÃ©ployÃ©es
npx supabase functions list

# RedÃ©ployer en mode debug
npx supabase functions deploy make-server-2eb02e52 --debug

# VÃ©rifier les imports UUID dans le code
grep -r "isValidUUID" supabase/functions/server/

# Compter les appels getUserById
grep -r "getUserById" supabase/functions/server/*.tsx | wc -l


ðŸ“‹ VARIABLES D'ENVIRONNEMENT NÃ‰CESSAIRES
--------------------------------------------------------------------------------

Ces variables sont dÃ©jÃ  configurÃ©es dans Supabase :
âœ… SUPABASE_URL
âœ… SUPABASE_ANON_KEY
âœ… SUPABASE_SERVICE_ROLE_KEY
âœ… SUPABASE_DB_URL

(Aucune nouvelle variable nÃ©cessaire pour cette correction)


ðŸ“‹ CHECKLIST DE VALIDATION
--------------------------------------------------------------------------------

PRÃ‰-DÃ‰PLOIEMENT :
[ ] Script verify-uuid-validation.sh exÃ©cutÃ© sans erreur
[ ] Tous les fichiers backend sont sauvegardÃ©s

DÃ‰PLOIEMENT :
[ ] Commande de dÃ©ploiement exÃ©cutÃ©e avec succÃ¨s
[ ] Aucune erreur de compilation
[ ] Backend dÃ©ployÃ© sur Supabase

POST-DÃ‰PLOIEMENT :
[ ] Endpoint /health rÃ©pond "ok"
[ ] Endpoint /version affiche "V6"
[ ] Test UUID invalide gÃ©rÃ© correctement

TEST FONCTIONNEL :
[ ] Approbation d'un conducteur rÃ©ussie
[ ] Aucune erreur UUID dans la console
[ ] Conducteur approuvÃ© voit son tableau de bord
[ ] Les 3 sources (KV, Auth, Postgres) synchronisÃ©es

SURVEILLANCE (24H) :
[ ] Logs backend sans erreur UUID
[ ] Nouveaux conducteurs approuvÃ©s fonctionnent
[ ] Aucune rÃ©gression dÃ©tectÃ©e


ðŸ“‹ FICHIERS DE RÃ‰FÃ‰RENCE
--------------------------------------------------------------------------------

Documentation :
- /DEPLOIEMENT_IMMEDIAT.md          â†’ Guide rapide (LIRE EN PREMIER)
- /GUIDE_DEPLOIEMENT_ET_TEST_UUID.md â†’ Guide complet et dÃ©taillÃ©
- /RESUME_CORRECTION_UUID.md        â†’ RÃ©sumÃ© de la correction
- /COMMANDES_DEPLOIEMENT.txt        â†’ Ce fichier (commandes uniquement)

Scripts :
- /verify-uuid-validation.sh        â†’ VÃ©rifier les validations UUID
- /test-uuid-fix.sh                 â†’ Tester le backend aprÃ¨s dÃ©ploiement
- /deploy-backend.bat               â†’ DÃ©ployer sur Windows
- /deploy-backend.ps1               â†’ DÃ©ployer sur Windows PowerShell

Backend (modifiÃ©s) :
- /supabase/functions/server/uuid-validator.ts      â†’ NOUVEAU (validateur)
- /supabase/functions/server/index.tsx              â†’ 4 validations ajoutÃ©es
- /supabase/functions/server/driver-routes.tsx      â†’ 3 validations ajoutÃ©es
- /supabase/functions/server/auth-routes.tsx        â†’ 9 validations ajoutÃ©es
- /supabase/functions/server/passenger-routes.tsx   â†’ 1 validation ajoutÃ©e
- /supabase/functions/server/diagnostic-driver-route.tsx â†’ 1 validation ajoutÃ©e


ðŸ“‹ SUPPORT
--------------------------------------------------------------------------------

Si vous rencontrez un problÃ¨me :

1. Capturer les logs :
   npx supabase functions logs make-server-2eb02e52 > logs-error.txt

2. DÃ©boguer un conducteur problÃ©matique :
   curl "https://[PROJECT_ID].supabase.co/functions/v1/make-server-2eb02e52/drivers/[DRIVER_ID]/debug" \
     -H "Authorization: Bearer [ANON_KEY]" > driver-debug.json

3. VÃ©rifier les imports :
   grep -r "uuid-validator" supabase/functions/server/

4. Fournir ces informations avec une description du problÃ¨me


================================================================================
âœ… CORRECTION UUID COMPLÃˆTE - PRÃŠT POUR DÃ‰PLOIEMENT
================================================================================

Date : 10 fÃ©vrier 2026
Version : V6 (SÃ©curitÃ© OWASP + Validation UUID)
PrioritÃ© : HAUTE (Bug critique rÃ©solu)
Statut : PRÃŠT POUR PRODUCTION

================================================================================
