#!/usr/bin/env node

/**
 * üîß G√âN√âRATION AUTOMATIQUE DU FICHIER info.tsx
 * 
 * Ce script g√©n√®re /utils/supabase/info.tsx depuis les variables d'environnement
 * Il s'ex√©cute AVANT le build Vite pour garantir la disponibilit√© des cl√©s
 * 
 * IMPORTANT: Extension .cjs car le projet utilise "type": "module"
 */

const fs = require('fs');
const path = require('path');

console.log('üîß G√©n√©ration du fichier info.tsx...');

// R√©cup√©rer les variables d'environnement et nettoyer TOUS les caract√®res invisibles
const rawProjectId = process.env.VITE_SUPABASE_PROJECT_ID || process.env.SUPABASE_PROJECT_ID || '';
const rawAnonKey = process.env.VITE_SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY || '';

// Nettoyer agressivement : supprimer newlines, carriage returns, tabs, espaces au d√©but/fin
const projectId = rawProjectId.replace(/[\r\n\t]/g, '').trim();
const publicAnonKey = rawAnonKey.replace(/[\r\n\t]/g, '').trim();

console.log('üìã Variables d\'environnement d√©tect√©es:');
console.log('   VITE_SUPABASE_PROJECT_ID:', process.env.VITE_SUPABASE_PROJECT_ID ? '‚úÖ' : '‚ùå');
console.log('   SUPABASE_PROJECT_ID:', process.env.SUPABASE_PROJECT_ID ? '‚úÖ' : '‚ùå');
console.log('   VITE_SUPABASE_ANON_KEY:', process.env.VITE_SUPABASE_ANON_KEY ? '‚úÖ' : '‚ùå');
console.log('   SUPABASE_ANON_KEY:', process.env.SUPABASE_ANON_KEY ? '‚úÖ' : '‚ùå');

// Debug : afficher les longueurs brutes vs nettoy√©es
console.log('');
console.log('üîç Nettoyage des variables:');
console.log('   Project ID - Longueur brute:', rawProjectId.length, '‚Üí Nettoy√©e:', projectId.length);
console.log('   Anon Key - Longueur brute:', rawAnonKey.length, '‚Üí Nettoy√©e:', publicAnonKey.length);

// Validation
if (!projectId) {
  console.error('');
  console.error('‚ùå ERREUR CRITIQUE: Project ID manquant !');
  console.error('');
  console.error('   Veuillez d√©finir une de ces variables d\'environnement:');
  console.error('   - VITE_SUPABASE_PROJECT_ID');
  console.error('   - SUPABASE_PROJECT_ID');
  console.error('');
  console.error('   Valeur attendue: zaerjqchzqmcxqblkfkg');
  console.error('');
  process.exit(1);
}

if (!publicAnonKey) {
  console.error('');
  console.error('‚ùå ERREUR CRITIQUE: Anon Key manquante !');
  console.error('');
  console.error('   Veuillez d√©finir une de ces variables d\'environnement:');
  console.error('   - VITE_SUPABASE_ANON_KEY');
  console.error('   - SUPABASE_ANON_KEY');
  console.error('');
  process.exit(1);
}

// Cr√©er le r√©pertoire si n√©cessaire
const dir = path.join(__dirname, '..', 'utils', 'supabase');
if (!fs.existsSync(dir)) {
  console.log('');
  console.log('üìÅ Cr√©ation du r√©pertoire utils/supabase...');
  fs.mkdirSync(dir, { recursive: true });
}

// G√©n√©rer le contenu du fichier avec concat√©nation (√©vite les probl√®mes de template strings)
const content = '/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */\n\n' +
  'export const projectId = "' + projectId + '"\n' +
  'export const publicAnonKey = "' + publicAnonKey + '"\n';

// √âcrire le fichier
const filePath = path.join(dir, 'info.tsx');
fs.writeFileSync(filePath, content, 'utf-8');

console.log('');
console.log('‚úÖ Fichier /utils/supabase/info.tsx g√©n√©r√© avec succ√®s !');
console.log('   Project ID:', projectId);
console.log('   Anon Key:', publicAnonKey.substring(0, 30) + '...');
console.log('');
